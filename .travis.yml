language: generic
sudo: required
before_install:
  - sudo apt-get update
  - sudo apt-get install gawk util-linux realpath qemu-user-static git p7zip-full python3 -y

install:
  - cd $TRAVIS_BUILD_DIR && cd ..
  - git clone https://github.com/guysoft/CustomPiOS.git
  - cd OctoPi/src/image
  - wget -c --trust-server-names 'https://downloads.raspberrypi.org/raspbian_lite_latest'

before_script:
  - cd $TRAVIS_BUILD_DIR/src
  - ../../CustomPiOS/src/update-custompios-paths
  - sudo modprobe loop

jobs:
  include:
    - stage: script
      name: Pi0 image
      script:
        - sudo bash -x ./build_dist
    - stage: script
      name: Pi3 image
      script:
        - sudo bash -x ./build_dist config_pi3.yaml

deploy:
  provider: releases
  api_key: $ACCESS_TOKEN
  file:
    - ${TRAVIS_BUILD_DIR}/src/workspace/*.img
  on:
    branches:
      only:
        - devel-upted
  skip_cleanup: true